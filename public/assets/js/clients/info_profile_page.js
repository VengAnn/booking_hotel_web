$(document).ready(function () {
    const defaultImage = "assets/icons/logo_profile.png";

    function fetchCurrentUser(user) {
        ajaxRequest({
            url: `/api/auth/current-user`,
            method: 'POST',
            data: { id: user.user_id },
            success: function (res) {
                const userData = res.data;
                const imageUrl = userData.user_profile ? userData.user_profile : defaultImage;

                $("#previewImage").attr("src", "storage/" + imageUrl);
                $("#username").val(userData.username || '');
                $("#phone").val(userData.phone || '');
            },
            error: function (err) {
                console.error('Failed to fetch user profile:', err);
                $("#previewImage").attr("src", defaultImage);
            }
        });
    }

    // 2Ô∏è‚É£ Preview selected image
    $("#profileImage").on("change", function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                $("#previewImage").attr("src", e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // Update profile
    $("#updateProfileBtn").on("click", function () {
        const formData = new FormData();

        formData.append('id', userData.user_id);
        formData.append('username', $("#username").val());
        formData.append('phone', $("#phone").val());
        formData.append('email', $("#email").val());

        const imageFile = $("#profileImage")[0].files[0];
        if (imageFile) {
            formData.append('user_profile', imageFile);
        }

        ajaxRequest({
            url: "/api/auth/update-profile",
            method: "POST",
            data: formData,
            success: () => {
                toastr.success("‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng");

                // Refresh image after successful update
                const userData = JSON.parse(localStorage.getItem("user-data") || '{}');
                if (userData?.user_id) {
                    fetchCurrentUser(userData);
                }
            },
            error: function (err) {
                console.error('Failed to update profile:', err);
                toastr.error("‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t", err.message);
            }
        });
    });

    // Change password
    $("#changePasswordBtn").on("click", function () {
        const htmlForm = `
            <form id="passwordChangeForm" class="mt-3">
                <div class="mb-3">
                    <label for="old_pass">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" class="form-control" id="old_pass" required>
                </div>
                <div class="mb-3">
                    <label for="new_pass">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" class="form-control" id="new_pass" required>
                </div>
                <div class="mb-3">
                    <label for="confirm_pass">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" class="form-control" id="confirm_pass" required>
                </div>
            </form>`;

        showConfirmDialog({
            title: "üîê ƒê·ªïi m·∫≠t kh·∫©u",
            content: htmlForm,
            type: "blue",
            confirmText: "C·∫≠p nh·∫≠t",
            onConfirm: function () {
                const oldPassword = $("#old_pass").val();
                const newPassword = $("#new_pass").val();
                const confirmPassword = $("#confirm_pass").val();

                if (!oldPassword || !newPassword || !confirmPassword) {
                    toastr.error("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin m·∫≠t kh·∫©u");
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    toastr.error("‚ùå M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp");
                    return false;
                }

                $.ajax({
                    url: "/api/auth/update-password",
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    }),
                    success: () => toastr.success("‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng"),
                    error: (err) => {
                        console.error(err);
                        toastr.error(err.responseJSON?.message || "‚ùå ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i");
                    }
                });
            }
        });
    });

    // 5Ô∏è‚É£ Init: load user image and info
    const userData = JSON.parse(localStorage.getItem("user-data") || '{}');
    if (userData?.user_id) {
        fetchCurrentUser(userData);
    } else {
        $("#previewImage").attr("src", defaultImage);
    }
});
